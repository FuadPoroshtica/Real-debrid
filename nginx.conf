events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Gzip
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json;

    # Upstream definitions
    upstream jellyfin {
        server jellyfin:8096;
    }

    upstream jellyseerr {
        server jellyseerr:5055;
    }

    upstream radarr {
        server radarr:7878;
    }

    upstream sonarr {
        server sonarr:8989;
    }

    upstream prowlarr {
        server prowlarr:9696;
    }

    # Main server block
    server {
        listen 80;
        server_name debrid.local;

        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;

        # Dashboard
        location / {
            root /usr/share/nginx/html;
            index index.html;
            try_files $uri $uri/ =404;
        }

        # Jellyfin
        location /jellyfin {
            return 301 $scheme://$host/jellyfin/;
        }

        location /jellyfin/ {
            proxy_pass http://jellyfin/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $http_host;

            proxy_buffering off;
        }

        # Jellyfin WebSocket
        location /jellyfin/socket {
            proxy_pass http://jellyfin/socket;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Jellyseerr
        location /jellyseerr {
            return 301 $scheme://$host/jellyseerr/;
        }

        location /jellyseerr/ {
            proxy_pass http://jellyseerr/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Radarr
        location /radarr {
            return 301 $scheme://$host/radarr/;
        }

        location /radarr/ {
            proxy_pass http://radarr/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Sonarr
        location /sonarr {
            return 301 $scheme://$host/sonarr/;
        }

        location /sonarr/ {
            proxy_pass http://sonarr/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Prowlarr
        location /prowlarr {
            return 301 $scheme://$host/prowlarr/;
        }

        location /prowlarr/ {
            proxy_pass http://prowlarr/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # WebDAV (Real-Debrid mount)
        location /webdav {
            proxy_pass http://realdebrid-mount:9999/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # WebDAV specific
            client_max_body_size 0;
            proxy_request_buffering off;
        }
    }
}
